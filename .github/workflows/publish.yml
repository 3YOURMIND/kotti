name: Publish Packages to NPM

on:
  push:
    branches:
      - master
      # TODO: Remove once vue3/upgrade is merged into master
      - vue3/upgrade

jobs:
  publish:
    runs-on: ubuntu-latest

    permissions:
      id-token: write

    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1

      - name: Install modules
        run: bun install

      # make extra sure this publish wouldnâ€™t break anything
      - run: bun run build check test

      # HACK: When putting this workflow into action, the pipeline did not find the
      # correct registry and/or Auth Token. To fix this we did the following:
      # - adding both of these lines (we are not sure if only one would have done the trick)
      # - using `bun publish` instead of `npm publish`
      - run: cp internals/scripts/source/npmrc-template /home/runner/work/_temp/.npmrc
      - run: cp internals/scripts/source/npmrc-template .npmrc

      - name: publish
        run: bun internals/scripts/source/publish.ts
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
